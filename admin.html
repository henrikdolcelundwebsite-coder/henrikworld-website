<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€” henrikworld.com</title>
  <style>
    body {
      margin: 0;
      background: white;
      color: black;
      font-family: monospace;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .editor {
      width: 80%;
      height: 70%;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      font-size: 16px;
      line-height: 1.5;
    }
    .line {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }
    .num {
      width: 40px;
      color: #888;
      text-align: right;
      padding-right: 10px;
    }
    .text {
      flex: 1;
      outline: none;
      white-space: pre;
    }
    button {
      background: #eee;
      border: 1px solid #ccc;
      padding: 8px 16px;
      cursor: pointer;
      font-family: monospace;
    }
    button:hover {
      background: #ddd;
    }
    .status { font-size: 13px; color: #444; }
  </style>
</head>
<body>
  <div class="editor" id="editor" aria-label="Admin command editor"></div>
  <button id="saveBtn">Save</button>
  <div class="status" id="status">Status: idle</div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js';
    import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA-Kcwv7BtU6cN41WbItJM1hInjy2Q83GI",
      authDomain: "henrikworld-818f9.firebaseapp.com",
      projectId: "henrikworld-818f9",
      storageBucket: "henrikworld-818f9.firebasestorage.app",
      messagingSenderId: "977398255809",
      appId: "1:977398255809:web:68febbb7f2cbc452064440",
      measurementId: "G-L2CKVDT4L3"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const db = getFirestore(app);

    const editor = document.getElementById('editor');
    const saveBtn = document.getElementById('saveBtn');
    const status = document.getElementById('status');

    let lineCount = 1;

    function createLine(num, content = '') {
      const line = document.createElement('div');
      line.className = 'line';

      const numDiv = document.createElement('div');
      numDiv.className = 'num';
      numDiv.textContent = num.toString().padStart(2, '0');

      const textDiv = document.createElement('div');
      textDiv.className = 'text';
      textDiv.contentEditable = true;
      textDiv.textContent = content;

      textDiv.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addNewLine();
        } else if (e.key === 'Backspace' && textDiv.textContent === '') {
          e.preventDefault();
          deleteLine(line);
        }
      });

      line.appendChild(numDiv);
      line.appendChild(textDiv);
      editor.appendChild(line);
      textDiv.focus();
    }

    function addNewLine() {
      lineCount++;
      createLine(lineCount);
      editor.scrollTop = editor.scrollHeight;
    }

    function deleteLine(line) {
      if (editor.children.length > 1) {
        line.remove();
        updateLineNumbers();
      }
    }

    function updateLineNumbers() {
      const lines = editor.querySelectorAll('.line');
      lineCount = lines.length;
      lines.forEach((line, index) => {
        line.querySelector('.num').textContent = (index + 1).toString().padStart(2, '0');
      });
    }

    // parse commands: create, delete, find
    function parseCommands(lines) {
      const createAccounts = [];
      const deleteAccounts = [];
      const findQueries = []; // {type: 'username'|'password', value}

      let currentCreate = null;
      let currentDelete = null;

      for (const raw of lines.map(l => l.trim())) {
        // Create sequence
        if (raw.startsWith('admin/account/create/username=')) {
          currentCreate = { username: raw.split('=')[1] || '' };
          continue;
        }
        if (raw.startsWith('admin/account/create/password=')) {
          if (currentCreate) currentCreate.password = raw.split('=')[1] || '';
          continue;
        }
        if (raw === 'admin/account/create/finish') {
          if (currentCreate && currentCreate.username && currentCreate.password) createAccounts.push(currentCreate);
          currentCreate = null;
          continue;
        }

        // Delete sequence
        if (raw.startsWith('admin/account/delete/username=')) {
          currentDelete = { username: raw.split('=')[1] || '' };
          continue;
        }
        if (raw === 'admin/account/delete/finish') {
          if (currentDelete && currentDelete.username) deleteAccounts.push(currentDelete);
          currentDelete = null;
          continue;
        }

        // Find queries (Option A style)
        if (raw.startsWith('admin/account/find/username=')) {
          findQueries.push({ type: 'username', value: raw.split('=')[1] || '' });
          continue;
        }
        if (raw.startsWith('admin/account/find/password=')) {
          findQueries.push({ type: 'password', value: raw.split('=')[1] || '' });
          continue;
        }

        // One-line lookup style (Option C) - accept as well
        if (raw.startsWith('admin/account/lookup/username=')) {
          findQueries.push({ type: 'username', value: raw.split('=')[1] || '' });
          continue;
        }
        if (raw.startsWith('admin/account/lookup/password=')) {
          findQueries.push({ type: 'password', value: raw.split('=')[1] || '' });
          continue;
        }
      }

      return { createAccounts, deleteAccounts, findQueries };
    }

    async function saveAccountsToFirestore(accounts) {
      const saved = [];
      for (const acc of accounts) {
        try {
          const docRef = await addDoc(collection(db, 'accounts'), { username: acc.username, password: acc.password, createdAt: serverTimestamp() });
          saved.push(acc.username);
        } catch(e) { console.error(e); }
      }
      return saved;
    }

    async function deleteAccountsFromFirestore(accounts) {
      const deleted = [];
      for (const acc of accounts) {
        try {
          const q = query(collection(db, 'accounts'), where('username', '==', acc.username));
          const querySnapshot = await getDocs(q);
          querySnapshot.forEach(async (document) => { await deleteDoc(doc(db, 'accounts', document.id)); });
          deleted.push(acc.username);
        } catch(e) { console.error(e); }
      }
      return deleted;
    }

    async function findInFirestore(queries) {
      // returns array of results per query
      const results = [];
      for (const q of queries) {
        try {
          if (q.type === 'username') {
            const qr = query(collection(db, 'accounts'), where('username', '==', q.value));
            const snap = await getDocs(qr);
            const found = [];
            snap.forEach(d => found.push({ id: d.id, username: d.data().username, password: d.data().password }));
            results.push({ query: q, found });
          } else if (q.type === 'password') {
            const qr = query(collection(db, 'accounts'), where('password', '==', q.value));
            const snap = await getDocs(qr);
            const found = [];
            snap.forEach(d => found.push({ id: d.id, username: d.data().username, password: d.data().password }));
            results.push({ query: q, found });
          }
        } catch(e) { console.error(e); results.push({ query: q, found: [], error: e.message }); }
      }
      return results;
    }

    saveBtn.addEventListener('click', async () => {
      status.textContent = 'Status: parsing...';
      const lines = Array.from(editor.querySelectorAll('.text')).map(t => t.textContent || '');
      const { createAccounts, deleteAccounts, findQueries } = parseCommands(lines);

      if (createAccounts.length === 0 && deleteAccounts.length === 0 && findQueries.length === 0) {
        status.textContent = 'Status: no valid commands found (nothing will be done)';
        return;
      }

      status.textContent = 'Status: processing...';

      const saved = await saveAccountsToFirestore(createAccounts);
      const deleted = await deleteAccountsFromFirestore(deleteAccounts);
      const foundResults = await findInFirestore(findQueries);

      let msgParts = [];
      if (saved.length) msgParts.push(`Created: ${saved.join(', ')}`);
      if (deleted.length) msgParts.push(`Deleted: ${deleted.join(', ')}`);

      // Build readable output for foundResults
      for (const r of foundResults) {
        if (r.error) {
          msgParts.push(`Query ${r.query.type}=${r.query.value} errored: ${r.error}`);
          continue;
        }
        if (!r.found || r.found.length === 0) {
          msgParts.push(`No results for ${r.query.type}=${r.query.value}`);
          continue;
        }
        // show actual password(s)
        const pairs = r.found.map(f => `${f.username} -> ${f.password}`);
        msgParts.push(`Found for ${r.query.type}=${r.query.value}: ${pairs.join('; ')}`);
      }

      const finalMsg = msgParts.join('. ') || 'No changes made.';
      status.textContent = `Status: ${finalMsg}`;
      alert(finalMsg);
    });

    createLine(lineCount);
  </script>
</body>
</html>
