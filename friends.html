<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Friends - henrikworld.com</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    body { font-family: monospace; background:white; color:black; margin:0; padding:0; min-height:100vh; display:flex; flex-direction:column; align-items:center; opacity:0; animation:fadeIn 0.6s ease-in-out forwards; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    #topBar { width:100%; display:flex; justify-content:space-between; padding:10px 15px; box-sizing:border-box; }
    #backBtn { background:white; border:1px solid #ccc; border-radius:4px; padding:6px 12px; cursor:pointer; }
    #backBtn:hover { background-color:#f5f5f5; }
    #usernameDisplay { border:1px solid #ccc; padding:6px 12px; border-radius:4px; }

    #tabs { display:flex; gap:10px; margin-top:10px; }
    .tab-btn { background:white; border:1px solid #ccc; border-radius:4px; padding:6px 12px; cursor:pointer; }
    .tab-btn.active { background-color:#eee; }
    .tab-btn:hover { background-color:#f5f5f5; }

    #content { margin-top:20px; width:90%; max-width:500px; text-align:left; }
    input { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; margin-bottom:10px; }
    button.action-btn { background:white; border:1px solid #ccc; border-radius:4px; padding:5px 10px; cursor:pointer; margin-left:5px; }
    button.action-btn:hover { background-color:#f5f5f5; }
    .friend-item { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:6px 0; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQnIe1Z-CMgyYOhKmfKVbLSall-R7frws",
      authDomain: "henrikworldonline-a726f.firebaseapp.com",
      projectId: "henrikworldonline-a726f",
      storageBucket: "henrikworldonline-a726f.firebasestorage.app",
      messagingSenderId: "1060990020059",
      appId: "1:1060990020059:web:35e9816d249cd32d97dffe",
      measurementId: "G-VQNK4YN1C5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;
    let activeTab = "friends";

    async function loadUser() {
      const saved = JSON.parse(localStorage.getItem("user"));
      if (!saved || !saved.username) { window.location.href = "login.html"; return; }
      currentUser = saved.username;
      document.getElementById("usernameDisplay").textContent = currentUser;
      showTab("friends");
    }

    async function showTab(tab) {
      activeTab = tab;
      document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
      document.getElementById(tab + "Tab").classList.add("active");
      const content = document.getElementById("content");
      content.innerHTML = "<p>Loading...</p>";

      if (tab === "friends") await loadFriends(content);
      else if (tab === "requests") await loadRequests(content);
      else if (tab === "search") showSearch(content);
    }

    async function loadFriends(container) {
      const q = query(collection(db, "friendships"), where("status","==","accepted"));
      const snapshot = await getDocs(q);
      const friends = snapshot.docs.map(d => d.data()).filter(f => f.user1 === currentUser || f.user2 === currentUser);

      if (!friends.length) { container.innerHTML = "<p>No friends yet.</p>"; return; }

      container.innerHTML = friends.map(f => {
        const friendName = f.user1 === currentUser ? f.user2 : f.user1;
        return `<div class="friend-item"><span>${friendName}</span><button class="action-btn" onclick="unfriend('${friendName}')">Unfriend</button></div>`;
      }).join("");
    }

    async function loadRequests(container) {
      const q = query(collection(db, "friendships"), where("status","==","pending"), where("user2","==",currentUser));
      const snapshot = await getDocs(q);
      if (snapshot.empty) { container.innerHTML="<p>No pending requests.</p>"; return; }

      container.innerHTML = snapshot.docs.map(d => {
        const data=d.data();
        return `<div class="friend-item"><span>${data.user1}</span>
          <div>
            <button class="action-btn" onclick="acceptRequest('${d.id}')">Accept</button>
            <button class="action-btn" onclick="rejectRequest('${d.id}')">Reject</button>
          </div></div>`;
      }).join("");
    }

    function showSearch(container) {
      container.innerHTML = `<input type="text" id="searchInput" placeholder="Search for a user..." />
        <div id="searchResults"></div>`;
      document.getElementById("searchInput").addEventListener("input", searchUsers);
    }

    async function searchUsers() {
      const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("searchResults");
      if (!searchTerm) { resultsDiv.innerHTML=""; return; }

      // Check accounts collection for users
      const q = query(collection(db,"accounts"));
      const snapshot = await getDocs(q);
      const matchedUsers = snapshot.docs.map(d => d.data().username)
        .filter(u => u.toLowerCase().includes(searchTerm) && u !== currentUser);

      if (!matchedUsers.length) { resultsDiv.innerHTML="<p>No users found.</p>"; return; }

      resultsDiv.innerHTML = matchedUsers.map(u => `<div class="friend-item"><span>${u}</span>
        <button class="action-btn" onclick="sendRequest('${u}')">Add Friend</button></div>`).join("");
    }

    async function sendRequest(target) {
      // Check if the target exists
      const q = query(collection(db,"accounts"), where("username","==",target));
      const snapshot = await getDocs(q);
      if (snapshot.empty) { alert("User does not exist."); return; }

      // Check for existing friendship or pending request
      const fQ = query(collection(db,"friendships"));
      const fSnap = await getDocs(fQ);
      for (const d of fSnap.docs) {
        const f=d.data();
        if ((f.user1===currentUser && f.user2===target) || (f.user1===target && f.user2===currentUser)) {
          alert("Already friends or request exists."); return;
        }
      }

      await addDoc(collection(db,"friendships"), {user1:currentUser,user2:target,status:"pending"});
      alert("Friend request sent!");
    }

    async function acceptRequest(id) { await updateDoc(doc(db,"friendships",id),{status:"accepted"}); showTab("requests"); }
    async function rejectRequest(id) { await deleteDoc(doc(db,"friendships",id)); showTab("requests"); }

    async function unfriend(target) {
      const q = query(collection(db,"friendships"), where("status","==","accepted"));
      const snapshot = await getDocs(q);
      for(const d of snapshot.docs){
        const f=d.data();
        if ((f.user1===currentUser && f.user2===target) || (f.user2===currentUser && f.user1===target)) {
          await deleteDoc(doc(db,"friendships",d.id));
        }
      }
      showTab("friends");
    }

    window.showTab = showTab;
    window.acceptRequest = acceptRequest;
    window.rejectRequest = rejectRequest;
    window.sendRequest = sendRequest;
    window.unfriend = unfriend;

    window.addEventListener("DOMContentLoaded", loadUser);
  </script>
</head>
<body>
  <div id="topBar">
    <button id="backBtn" onclick="window.location.href='index.html'">Back</button>
    <div id="usernameDisplay"></div>
  </div>

  <div id="tabs">
    <button id="friendsTab" class="tab-btn" onclick="showTab('friends')">My Friends</button>
    <button id="requestsTab" class="tab-btn" onclick="showTab('requests')">Requests</button>
    <button id="searchTab" class="tab-btn" onclick="showTab('search')">Search</button>
  </div>

  <div id="content"></div>
</body>
</html>
