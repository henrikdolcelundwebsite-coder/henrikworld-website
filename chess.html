<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplayer Chess</title>
<style>
    body {
        margin: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f0f0f0;
        font-family: 'Arial', sans-serif;
    }

    .code {
        font-size: 28px;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        font-family: monospace;
        letter-spacing: 3px;
    }

    #playerInfo {
        font-size: 20px;
        color: #333;
        margin-bottom: 10px;
    }

    .join-container {
        margin-bottom: 10px;
    }
    .join-container input {
        font-size: 18px;
        text-transform: uppercase;
        padding: 4px 8px;
    }
    .join-container button {
        font-size: 18px;
        cursor: pointer;
        padding: 4px 8px;
    }

    .chess-board {
        display: grid;
        grid-template-columns: repeat(8, 60px);
        grid-template-rows: repeat(8, 60px);
        border: 4px solid #5c4033;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    }

    .chess-board div {
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }

    .chess-board .light {
        background-color: #d9c4a9;
    }

    .chess-board .dark {
        background-color: #8b6d5c;
    }

    .chess-board img {
        width: 50px;
        height: 50px;
        pointer-events: none;
        opacity: 0;
        transform: translateY(-100px);
        transition: transform 0.5s ease, opacity 0.5s ease;
    }

    .selected {
        outline: 3px solid #00ffbf;
        border-radius: 8px;
    }
</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

</head>
<body>

<div class="join-container">
    <input type="text" id="joinCode" placeholder="Enter Room Code" maxlength="5">
    <button id="joinBtn">Join Game</button>
</div>

<div class="code" id="randomCode"></div>
<div id="playerInfo"></div>
<div class="chess-board" id="chessBoard"></div>

<script>
    // =====================
    // Firebase Initialization
    // =====================
    const firebaseConfig = {
        apiKey: "AIzaSyCzLVYotT_Vh7IorsB7hsVWeb5PddIyVC0",
        authDomain: "onlinegames-42c40.firebaseapp.com",
        projectId: "onlinegames-42c40",
        storageBucket: "onlinegames-42c40.firebasestorage.app",
        messagingSenderId: "531435305907",
        appId: "1:531435305907:web:11c8803f9fcd72424069c6",
        measurementId: "G-Y5N8STJP16"
    };
    firebase.initializeApp(firebaseConfig);
    const analytics = firebase.analytics();
    const db = firebase.firestore();
    const auth = firebase.auth();

    // =====================
    // Chess Board Setup
    // =====================
    const boardEl = document.getElementById('chessBoard');
    const initialBoard = [
        ['black-rook','black-knight','black-bishop','black-queen','black-king','black-bishop','black-knight','black-rook'],
        ['black-pawn','black-pawn','black-pawn','black-pawn','black-pawn','black-pawn','black-pawn','black-pawn'],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['white-pawn','white-pawn','white-pawn','white-pawn','white-pawn','white-pawn','white-pawn','white-pawn'],
        ['white-rook','white-knight','white-bishop','white-queen','white-king','white-bishop','white-knight','white-rook']
    ];

    for (let row=0; row<8; row++){
        for (let col=0; col<8; col++){
            const square = document.createElement('div');
            square.classList.add((row+col)%2 ===0 ? 'light':'dark');
            boardEl.appendChild(square);
        }
    }
    const squares = boardEl.children;

    // =====================
    // Drop Pieces Animation
    // =====================
    function dropPiecesSequentially(pieceColor){
        let index = 0;
        const rows = pieceColor==='black' ? [0,1]:[6,7];
        return new Promise(resolve=>{
            function dropNext(){
                if(index >= rows.length*8){ resolve(); return; }
                const row = rows[Math.floor(index/8)];
                const col = index%8;
                const piece = initialBoard[row][col];
                const square = squares[row*8+col];
                square.innerHTML = '';
                if(piece){
                    const img = document.createElement('img');
                    img.src = `chessimages/${piece}.png`;
                    img.alt = piece;
                    square.appendChild(img);
                    setTimeout(()=>{img.style.transform='translateY(0)'; img.style.opacity='1';},50);
                }
                index++;
                setTimeout(dropNext,100);
            }
            dropNext();
        });
    }

    async function dropAllPieces(){ await dropPiecesSequentially('black'); await dropPiecesSequentially('white'); }

    // =====================
    // Room Code & Player Info
    // =====================
    const codeEl = document.getElementById('randomCode');
    const playerInfoEl = document.getElementById('playerInfo');
    let currentPlayer = null;
    let roomCode = localStorage.getItem('roomCode');
    let selectedPiece = null;
    let selectedRow = null;
    let selectedCol = null;

    function generateCode(){
        const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code='';
        for(let i=0;i<5;i++){ code+=chars.charAt(Math.floor(Math.random()*chars.length)); }
        return code;
    }

    if(!roomCode){
        roomCode = generateCode();
        localStorage.setItem('roomCode', roomCode);
    }
    codeEl.textContent = roomCode; // always display immediately

    // =====================
    // Join or Create Room
    // =====================
    async function joinOrCreateRoom(inputCode){
        const codeToUse = inputCode || roomCode;
        const roomRef = db.collection("rooms").doc(codeToUse);
        const roomDoc = await roomRef.get();

        if(roomDoc.exists){
            const data = roomDoc.data();
            if(!data.players.player2){ await roomRef.update({'players.player2':'guest'}); }
            currentPlayer = data.players.player1==='host' ? 'white':'black';
        } else {
            await roomRef.set({
                board: initialBoard,
                turn: "white",
                players: {player1:'host',player2:null}
            });
            currentPlayer='white';
        }
        roomCode=codeToUse;
        localStorage.setItem('roomCode',roomCode);
        codeEl.textContent=roomCode;
        listenToRoom();
    }

    document.getElementById('joinBtn').addEventListener('click',async()=>{
        const inputCode=document.getElementById('joinCode').value.toUpperCase();
        if(inputCode.length===5){
            await joinOrCreateRoom(inputCode);
            alert(`Joined room ${inputCode}`);
        } else {
            alert('Please enter a valid 5-character room code.');
        }
    });

    // =====================
    // Real-time Listener
    // =====================
    function listenToRoom(){
        const roomRef=db.collection("rooms").doc(roomCode);
        roomRef.onSnapshot(doc=>{
            if(doc.exists){
                const data=doc.data();
                for(let r=0;r<8;r++){
                    for(let c=0;c<8;c++){
                        initialBoard[r][c]=data.board[r][c];
                    }
                }
                updateBoardFromData(data.board);
                updatePlayerInfo(data.turn);
            }
        });
    }

    function updateBoardFromData(boardData){
        for(let row=0; row<8; row++){
            for(let col=0; col<8; col++){
                const square=squares[row*8+col];
                square.innerHTML='';
                const piece=boardData[row][col];
                if(piece){
                    const img=document.createElement('img');
                    img.src=`chessimages/${piece}.png`;
                    img.alt=piece;
                    square.appendChild(img);
                    img.style.transform='translateY(0)';
                    img.style.opacity='1';
                }
            }
        }
    }

    function updatePlayerInfo(turn){
        let roleText=currentPlayer==='white' ? 'You are White':'You are Black';
        let turnText=(turn===currentPlayer) ? 'Your turn':"Opponent's turn";
        playerInfoEl.textContent=`${roleText} - ${turnText}`;
    }

    function updateBoardInFirebase(newBoard){
        db.collection("rooms").doc(roomCode).update({
            board:newBoard,
            turn: currentPlayer==='white' ? 'black':'white'
        });
    }

    // =====================
    // Click-to-Move Logic
    // =====================
    for(let row=0; row<8; row++){
        for(let col=0; col<8; col++){
            const square = squares[row*8+col];
            square.addEventListener('click',()=>{
                if(!currentPlayer) return;
                db.collection("rooms").doc(roomCode).get().then(doc=>{
                    if(!doc.exists) return;
                    const turn = doc.data().turn;
                    if(turn!==currentPlayer) return;

                    const piece = initialBoard[row][col];

                    if(piece && piece.startsWith(currentPlayer)){
                        if(selectedRow!==null && selectedCol!==null){
                            squares[selectedRow*8+selectedCol].classList.remove('selected');
                        }
                        selectedPiece = piece;
                        selectedRow = row;
                        selectedCol = col;
                        square.classList.add('selected');
                        return;
                    }

                    if(selectedPiece){
                        initialBoard[row][col] = selectedPiece;
                        initialBoard[selectedRow][selectedCol] = '';
                        squares[selectedRow*8+selectedCol].classList.remove('selected');
                        selectedPiece=null;
                        selectedRow=null;
                        selectedCol=null;
                        updateBoardInFirebase(initialBoard);
                    }
                });
            });
        }
    }

    // =====================
    // Initialize Game After Auth
    // =====================
    auth.signInAnonymously()
        .then(() => {
            console.log("Signed in anonymously");
            dropAllPieces().then(()=>joinOrCreateRoom());
        })
        .catch(err=>console.error("Auth error:",err));
</script>
</body>
</html>
