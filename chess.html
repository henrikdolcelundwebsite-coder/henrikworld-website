<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chess - henrikworld</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
body {
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  margin:0;
  font-family: Arial,sans-serif;
  height:100vh;
  background:white;
}
#playersTop, #playersBottom { font-weight:bold; text-align:center; margin:5px 0; }
#gameCode { margin-bottom:10px; font-weight:bold; font-size:1.5rem; text-align:center; }
#turnDisplay, #moveLog { margin-top:5px; font-weight:bold; text-align:center; }
.chessboard {
  display:grid;
  grid-template-columns: repeat(8, 80px);
  grid-template-rows: repeat(8, 80px);
  border:6px solid #222;
  border-radius:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);
  overflow:hidden;
}
.square {
  width:80px;
  height:80px;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
  cursor:pointer;
}
.white { background-color:#f0d9b5; }
.black { background-color:#b58863; }
.square img { max-width:70%; max-height:70%; pointer-events:none; }

/* Highlight selected piece */
.selected { 
  background-color: rgba(65, 105, 225, 0.6) !important;
}
/* Highlight possible moves */
.possible { 
  background-color: rgba(30, 144, 255, 0.4);
}
</style>
</head>
<body>

<div id="gameCode"></div>
<div id="playersTop"></div>
<div class="chessboard" id="chessboard"></div>
<div id="playersBottom"></div>
<div id="turnDisplay"></div>
<div id="moveLog"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDmFdbny6w6noCga2YU_sVQvvoAEK-_3vY",
  authDomain: "onlinewebsite-e55c8.firebaseapp.com",
  projectId: "onlinewebsite-e55c8",
  storageBucket: "onlinewebsite-e55c8.firebasestorage.app",
  messagingSenderId: "153855517055",
  appId: "1:153855517055:web:eee5c6739bfa16ca78fa4a",
  measurementId: "G-6WK0BFJ0DS"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const username = localStorage.getItem('username');
if(!username){ window.location.href='login.html'; }
const docId = params.get('docId');

const playersTopDiv = document.getElementById('playersTop');
const playersBottomDiv = document.getElementById('playersBottom');
const chessboard = document.getElementById('chessboard');
const turnDisplay = document.getElementById('turnDisplay');
const gameCodeDiv = document.getElementById('gameCode');
const moveLogDiv = document.getElementById('moveLog');

const gameRef = doc(db, 'games', docId);

const pieceImages = {
  wP:'chessimages/white-pawn.png', wR:'chessimages/white-rook.png',
  wN:'chessimages/white-knight.png', wB:'chessimages/white-bishop.png',
  wQ:'chessimages/white-queen.png', wK:'chessimages/white-king.png',
  bP:'chessimages/black-pawn.png', bR:'chessimages/black-rook.png',
  bN:'chessimages/black-knight.png', bB:'chessimages/black-bishop.png',
  bQ:'chessimages/black-queen.png', bK:'chessimages/black-king.png'
};

function getDefaultBoard(){
  return [
    ['bR','bN','bB','bQ','bK','bB','bN','bR'],
    ['bP','bP','bP','bP','bP','bP','bP','bP'],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['wP','wP','wP','wP','wP','wP','wP','wP'],
    ['wR','wN','wB','wQ','wK','wB','wN','wR']
  ];
}

function boardToObject(board){
  const obj = {};
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      obj[`${r}-${c}`] = board[r][c];
    }
  }
  return obj;
}

function objectToBoard(obj){
  const board = Array(8).fill(null).map(()=>Array(8).fill(''));
  for(const key in obj){
    const [r,c] = key.split('-').map(Number);
    board[r][c] = obj[key];
  }
  return board;
}

let boardData = getDefaultBoard();
let turn = 'white';
let selectedSquare = null;
let hostUser = '';
let guestUser = '';

// Convert row,col to chess notation like e4
function squareToNotation(r,c){
  const files = ['a','b','c','d','e','f','g','h'];
  return files[c]+(8-r);
}

function renderBoard(possibleMoves=[]){
  chessboard.innerHTML='';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const sq = document.createElement('div');
      sq.className = (r+c)%2===0?'square white':'square black';
      sq.dataset.row=r;
      sq.dataset.col=c;
      const piece = boardData[r][c];
      if(piece){
        const img = document.createElement('img');
        img.src = pieceImages[piece];
        img.dataset.piece = piece;
        sq.appendChild(img);
      }
      if(selectedSquare && selectedSquare.row===r && selectedSquare.col===c){
        sq.classList.add('selected');
      }
      if(possibleMoves.some(m=>m.row===r && m.col===c)){
        sq.classList.add('possible');
      }
      chessboard.appendChild(sq);
    }
  }
}

function isMyTurn(piece){
  if(!piece) return false;
  const color = piece[0]==='w'?'white':'black';
  return (username===hostUser && color==='white' && turn==='white') ||
         (username===guestUser && color==='black' && turn==='black');
}

// Basic legal moves
function getPossibleMoves(r,c){ 
  const piece = boardData[r][c];
  if(!piece) return [];
  const color = piece[0]==='w'?'white':'black';
  const moves=[];
  const directions={
    N:[[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]],
    B:[[1,1],[1,-1],[-1,1],[-1,-1]],
    R:[[1,0],[-1,0],[0,1],[0,-1]],
    Q:[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]],
    K:[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]
  };
  function inBounds(x,y){ return x>=0 && x<8 && y>=0 && y<8; }

  if(piece[1]==='P'){
    const forward = color==='white'? -1:1;
    if(inBounds(r+forward,c) && !boardData[r+forward][c]) moves.push({row:r+forward,col:c});
    if((color==='white' && r===6)||(color==='black' && r===1)){
      if(!boardData[r+forward][c] && !boardData[r+2*forward][c]) moves.push({row:r+2*forward,col:c});
    }
    const caps = color==='white'? [[-1,-1],[-1,1]]:[[1,-1],[1,1]];
    for(const d of caps){
      const nr=r+d[0], nc=c+d[1];
      if(inBounds(nr,nc) && boardData[nr][nc] && boardData[nr][nc][0]!==piece[0]) moves.push({row:nr,col:nc});
    }
  } else if(piece[1]==='N'){
    for(const d of directions.N){
      const nr=r+d[0], nc=c+d[1];
      if(inBounds(nr,nc) && (!boardData[nr][nc] || boardData[nr][nc][0]!==piece[0])) moves.push({row:nr,col:nc});
    }
  } else if(piece[1]==='B' || piece[1]==='R' || piece[1]==='Q'){
    const dirs = piece[1]==='B'? directions.B : piece[1]==='R'? directions.R : directions.Q;
    for(const d of dirs){
      let nr=r+d[0], nc=c+d[1];
      while(inBounds(nr,nc)){
        if(!boardData[nr][nc]) moves.push({row:nr,col:nc});
        else { if(boardData[nr][nc][0]!==piece[0]) moves.push({row:nr,col:nc}); break; }
        nr+=d[0]; nc+=d[1];
      }
    }
  } else if(piece[1]==='K'){
    for(const d of directions.K){
      const nr=r+d[0], nc=c+d[1];
      if(inBounds(nr,nc) && (!boardData[nr][nc] || boardData[nr][nc][0]!==piece[0])) moves.push({row:nr,col:nc});
    }
  }
  return moves;
}

// Snapshot updates
onSnapshot(gameRef, async (snap)=>{
  const data = snap.data();
  if(!data) return;
  hostUser = data.players[0];
  guestUser = data.players[1] || null;

  if(!data.board || Object.keys(data.board).length===0){
    boardData = getDefaultBoard();
    await updateDoc(gameRef, { board: boardToObject(boardData) });
  } else boardData = objectToBoard(data.board);

  turn = data.turn || 'white';
  turnDisplay.textContent = `Turn: ${turn}`;
  gameCodeDiv.textContent = `Game Code: ${data.code}`;

  playersTopDiv.textContent = guestUser ? ((guestUser===username)? `${guestUser} (You)`:`${guestUser} (Guest)`) : 'Waiting for player...';
  playersBottomDiv.textContent = (hostUser===username)? `${hostUser} (You)` : `${hostUser} (Host)`;

  renderBoard();
});

// Add joining player
(async()=>{
  const docSnap = await getDoc(gameRef);
  const data = docSnap.data();
  if(!data.players.includes(username)){
    await updateDoc(gameRef, { players: [...data.players, username] });
  }
})();

// Click to select/move
chessboard.addEventListener('click', async (e)=>{
  const sq = e.target.closest('.square');
  if(!sq) return;
  const row=parseInt(sq.dataset.row), col=parseInt(sq.dataset.col);
  const piece = boardData[row][col];

  if(selectedSquare && selectedSquare.row===row && selectedSquare.col===col){
    selectedSquare=null; renderBoard(); return;
  }

  if(selectedSquare){
    const moves = getPossibleMoves(selectedSquare.row, selectedSquare.col);
    if(moves.some(m=>m.row===row && m.col===col)){
      const movingPiece = boardData[selectedSquare.row][selectedSquare.col];
      boardData[row][col]=movingPiece;
      boardData[selectedSquare.row][selectedSquare.col]='';
      const moveText = `${username} moved ${squareToNotation(selectedSquare.row, selectedSquare.col)} to ${squareToNotation(row,col)}`;
      moveLogDiv.textContent = moveText;
      selectedSquare=null;
      turn = (turn==='white')?'black':'white';
      await updateDoc(gameRef, { board:boardToObject(boardData), turn:turn });
    } else { selectedSquare=null; renderBoard(); return; }
  } else if(piece && isMyTurn(piece)){
    selectedSquare={row,col};
    const moves = getPossibleMoves(row,col);
    renderBoard(moves);
  }
});
</script>

</body>
</html>
