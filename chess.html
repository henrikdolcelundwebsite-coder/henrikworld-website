<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chess - henrikworld</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
  body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin: 0;
    font-family: Arial, sans-serif;
    min-height: 100vh;
    background: #fefefe;
    padding: 10px;
  }

  #playersTop, #playersBottom {
    font-weight: bold;
    text-align: center;
    margin: 5px 0;
  }

  #gameCode {
    margin-bottom: 10px;
    font-weight: bold;
    font-size: 1.2rem;
    text-align: center;
  }

  #turnDisplay, #moveLog {
    margin-top: 5px;
    font-weight: bold;
    text-align: center;
  }

  /* Chessboard */
  .chessboard {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    grid-template-rows: repeat(8, 1fr);
    width: 90vw;
    max-width: 640px;
    aspect-ratio: 1;
    border: 6px solid #222;
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    overflow: hidden;
  }

  .square {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    cursor: pointer;
  }

  .white { background-color: #f0d9b5; }
  .black { background-color: #b58863; }
  .square img { max-width: 70%; max-height: 70%; pointer-events: none; }

  .selected { background-color: rgba(65, 105, 225, 0.6) !important; }
  .possible { background-color: rgba(30, 144, 255, 0.4); }

  /* Chat */
  #chatBox {
    width: 90%;
    max-width: 640px;
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    overflow: hidden;
    padding: 8px;
  }

  #chatMessages {
    flex: 1;
    height: 200px;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .message {
    max-width: 75%;
    padding: 8px 12px;
    border-radius: 16px;
    font-size: 0.9rem;
    line-height: 1.4;
    word-wrap: break-word;
  }

  .message.you {
    align-self: flex-end;
    background: #4a90e2;
    color: white;
    border-bottom-right-radius: 4px;
  }

  .message.other {
    align-self: flex-start;
    background: #e5e5ea;
    color: #222;
    border-bottom-left-radius: 4px;
  }

  #chatControls {
    display: flex;
    border-top: 1px solid #ddd;
  }

  #chatInput {
    flex: 1;
    border: none;
    padding: 10px;
    font-size: 0.95rem;
    outline: none;
  }

  #sendChat {
    background: #4a90e2;
    border: none;
    color: white;
    padding: 0 16px;
    font-size: 0.95rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  #sendChat:hover { background: #357abd; }
</style>
</head>
<body>

<div id="gameCode"></div>
<div id="playersTop"></div>
<div class="chessboard" id="chessboard"></div>
<div id="playersBottom"></div>
<div id="turnDisplay"></div>
<div id="moveLog"></div>

<!-- Chat -->
<div id="chatBox">
  <div id="chatMessages"></div>
  <div id="chatControls">
    <input type="text" id="chatInput" placeholder="Type a message...">
    <button id="sendChat">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, doc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDmFdbny6w6noCga2YU_sVQvvoAEK-_3vY",
  authDomain: "onlinewebsite-e55c8.firebaseapp.com",
  projectId: "onlinewebsite-e55c8",
  storageBucket: "onlinewebsite-e55c8.appspot.com",
  messagingSenderId: "153855517055",
  appId: "1:153855517055:web:eee5c6739bfa16ca78fa4a",
  measurementId: "G-6WK0BFJ0DS"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const username = localStorage.getItem('username');
if(!username){ window.location.href='login.html'; }
const docId = params.get('docId');

const playersTopDiv = document.getElementById('playersTop');
const playersBottomDiv = document.getElementById('playersBottom');
const chessboard = document.getElementById('chessboard');
const turnDisplay = document.getElementById('turnDisplay');
const gameCodeDiv = document.getElementById('gameCode');
const moveLogDiv = document.getElementById('moveLog');
const chatMessagesDiv = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChat');

const gameRef = doc(db, 'games', docId);

const pieceImages = {
  wP:'chessimages/white-pawn.png', wR:'chessimages/white-rook.png',
  wN:'chessimages/white-knight.png', wB:'chessimages/white-bishop.png',
  wQ:'chessimages/white-queen.png', wK:'chessimages/white-king.png',
  bP:'chessimages/black-pawn.png', bR:'chessimages/black-rook.png',
  bN:'chessimages/black-knight.png', bB:'chessimages/black-bishop.png',
  bQ:'chessimages/black-queen.png', bK:'chessimages/black-king.png'
};

function getDefaultBoard(){
  return [
    ['bR','bN','bB','bQ','bK','bB','bN','bR'],
    ['bP','bP','bP','bP','bP','bP','bP','bP'],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['wP','wP','wP','wP','wP','wP','wP','wP'],
    ['wR','wN','wB','wQ','wK','wB','wN','wR']
  ];
}

function boardToObject(board){
  const obj = {};
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      obj[`${r}-${c}`] = board[r][c];
    }
  }
  return obj;
}

function objectToBoard(obj){
  const board = Array(8).fill(null).map(()=>Array(8).fill(''));
  for(const key in obj){
    const [r,c] = key.split('-').map(Number);
    board[r][c] = obj[key];
  }
  return board;
}

let boardData = getDefaultBoard();
let turn = 'white';
let selectedSquare = null;
let hostUser = '';
let guestUser = '';

function squareToNotation(r,c){
  const files = ['a','b','c','d','e','f','g','h'];
  return files[c]+(8-r);
}

function renderBoard(possibleMoves=[]){
  chessboard.innerHTML='';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const sq = document.createElement('div');
      sq.className = (r+c)%2===0?'square white':'square black';
      sq.dataset.row=r;
      sq.dataset.col=c;
      const piece = boardData[r][c];
      if(piece){
        const img = document.createElement('img');
        img.src = pieceImages[piece];
        img.dataset.piece = piece;
        sq.appendChild(img);
      }
      chessboard.appendChild(sq);
    }
  }
}

/* ------------ Chat ------------ */
sendChatBtn.addEventListener('click', async ()=>{
  const text = chatInput.value.trim();
  if(!text) return;
  await updateDoc(gameRef,{chat:arrayUnion({user:username,text:text,type:'text'})});
  chatInput.value='';
});

/* ------------ Game Sync ------------ */
onSnapshot(gameRef, async (snap)=>{
  const data = snap.data();
  if(!data) return;

  hostUser = data.players[0];
  guestUser = data.players[1] || null;

  if(!data.board || Object.keys(data.board).length===0){
    boardData = getDefaultBoard();
    await updateDoc(gameRef, { board: boardToObject(boardData) });
  } else boardData = objectToBoard(data.board);

  turn = data.turn || 'white';
  turnDisplay.textContent = `Turn: ${turn}`;
  gameCodeDiv.textContent = `Game Code: ${data.code}`;

  playersTopDiv.textContent = guestUser ? ((guestUser===username)? `${guestUser} (You)`:`${guestUser} (Guest)`) : 'Waiting for player...';
  playersBottomDiv.textContent = (hostUser===username)? `${hostUser} (You)` : `${hostUser} (Host)`;

  // Render chat with smooth auto-scroll
  if(data.chat){
    chatMessagesDiv.innerHTML = '';
    data.chat.forEach(msg=>{
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(msg.user===username ? 'you':'other');
      div.textContent = msg.text;
      chatMessagesDiv.appendChild(div);
    });

    setTimeout(() => {
      chatMessagesDiv.scrollTo({
        top: chatMessagesDiv.scrollHeight,
        behavior: 'smooth'
      });
    }, 100);
  }

  renderBoard();
});
</script>
</body>
</html>
