<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chat - Henrik World</title>
<link rel="icon" type="image/png" href="favicon.png" />
<style>
  body {
    font-family: monospace;
    background-color: white;
    color: black;
    margin: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  #contentWrapper {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }

  #pageTitle {
    font-size: 28px;
    font-weight: bold;
    color: #333;
    margin-bottom: 15px;
    text-align: center;
  }

  #topBar {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  #backBtn {
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
  }
  #backBtn:hover { background-color: #f5f5f5; }

  #usernameDisplay {
    font-weight: bold;
    font-size: 16px;
    background-color: #f9f9f9;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
  }

  #chatContainer {
    display: flex;
    flex: 1;
    overflow: hidden;
    gap: 10px;
  }

  #friendsList {
    width: 25%;
    min-width: 180px;
    border-right: 1px solid #ccc;
    overflow-y: auto;
    padding: 10px;
    box-sizing: border-box;
    background-color: #fafafa;
    border-radius: 6px;
  }
  #friendsList div {
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
  }
  #friendsList div:hover, #friendsList .active {
    background-color: #f0f0f0;
  }

  #chatArea {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px 15px;
    box-sizing: border-box;
    overflow: hidden;
    border-radius: 6px;
    background-color: #fdfdfd;
    border: 1px solid #eee;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 10px;
    padding-right: 5px;
  }
  .message {
    margin-bottom: 12px;
    word-break: break-word;
  }
  .message img {
    max-width: 250px;
    display: block;
    margin-top: 4px;
    border-radius: 6px;
  }
  .message .meta {
    font-size: 10px;
    color: #888;
    margin-top: 2px;
  }

  #messageForm {
    display: flex;
    gap: 8px;
  }
  #messageInput {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-family: monospace;
    font-size: 14px;
  }
  #imageInput {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
  }
  #sendBtn {
    padding: 10px 16px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background-color: white;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
  }
  #sendBtn:hover { background-color: #f5f5f5; }

  @media (max-width: 768px) {
    #chatContainer {
      flex-direction: column;
    }
    #friendsList {
      width: 100%;
      max-height: 150px;
      border-right: none;
      border-bottom: 1px solid #ccc;
      display: flex;
      overflow-x: auto;
      gap: 6px;
    }
    #friendsList div {
      flex: 1 0 auto;
      margin-bottom: 0;
      text-align: center;
    }
  }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, addDoc, orderBy, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAQnIe1Z-CMgyYOhKmfKVbLSall-R7frws",
  authDomain: "henrikworldonline-a726f.firebaseapp.com",
  projectId: "henrikworldonline-a726f",
  storageBucket: "henrikworldonline-a726f.firebasestorage.app",
  messagingSenderId: "1060990020059",
  appId: "1:1060990020059:web:35e9816d249cd32d97dffe",
  measurementId: "G-VQNK4YN1C5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let activeFriend = null;
let activeChatId = null;
let messagesListener = null;
let friendsMap = {};

async function loadUser() {
  const saved = JSON.parse(localStorage.getItem("user"));
  if (!saved || !saved.username) { window.location.href="login.html"; return; }
  currentUser = saved.username;
  document.getElementById("usernameDisplay").textContent = currentUser;
  await loadFriends();
}

async function loadFriends() {
  const q = query(collection(db,"friendships"), where("status","==","accepted"));
  const snapshot = await getDocs(q);
  const friends = snapshot.docs
    .map(d => d.data())
    .filter(f => f.user1 === currentUser || f.user2 === currentUser)
    .map(f => f.user1 === currentUser ? f.user2 : f.user1);

  friendsMap = {"General Chat": {}};
  friends.forEach(f => friendsMap[f] = {});
  renderFriends();
}

function renderFriends() {
  const friendsList = document.getElementById("friendsList");
  const sortedFriends = Object.keys(friendsMap);
  friendsList.innerHTML = sortedFriends.map(f => {
    return `<div onclick="selectFriend('${f}', this)">${f}</div>`;
  }).join("");
}

function selectFriend(friend, el) {
  activeFriend = friend;
  Array.from(document.getElementById("friendsList").children).forEach(d=>d.classList.remove("active"));
  el.classList.add("active");

  activeChatId = (friend==="General Chat") ? "general" : [currentUser, activeFriend].sort().join("_");
  (friend==="General Chat") ? loadGeneralChat() : loadMessages();
}

function loadMessages() {
  if (!activeFriend) return;
  if (messagesListener) messagesListener();
  const messagesDiv = document.getElementById("messages");
  messagesDiv.innerHTML = "";
  const q = query(collection(db,"messages"), where("chatId","==",activeChatId), orderBy("timestamp"));
  messagesListener = onSnapshot(q, snapshot => {
    messagesDiv.innerHTML = snapshot.docs.map(d=>{
      const m = d.data();
      const time = m.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const sender = m.from===currentUser?"You":m.from;
      let content = m.message ? `<strong>${sender}:</strong> ${m.message}` : `<strong>${sender}:</strong> <img src="${m.imageURL}" />`;
      return `<div class="message">${content}<div class="meta">${time}</div></div>`;
    }).join("");
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

const generalCollection = collection(db,"generalMessages");
function loadGeneralChat() {
  const messagesDiv = document.getElementById("messages");
  if (messagesListener) messagesListener();
  messagesListener = onSnapshot(query(generalCollection, orderBy("timestamp")), snapshot => {
    messagesDiv.innerHTML = snapshot.docs.map(d=>{
      const m = d.data();
      const time = m.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      let content = m.message ? `<strong>${m.from}:</strong> ${m.message}` : `<strong>${m.from}:</strong> <img src="${m.imageURL}" />`;
      return `<div class="message">${content}<div class="meta">${time}</div></div>`;
    }).join("");
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

async function sendMessage() {
  const input = document.getElementById("messageInput");
  const imageInput = document.getElementById("imageInput");
  if (!activeFriend) return;

  if (imageInput.files.length > 0) {
    const file = imageInput.files[0];
    const storageRef = ref(storage, `chatImages/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    if (activeFriend==="General Chat") {
      await addDoc(generalCollection, {from:currentUser, imageURL:url, timestamp:Timestamp.now()});
    } else {
      await addDoc(collection(db,"messages"), {chatId:activeChatId, from:currentUser, to:activeFriend, imageURL:url, timestamp:Timestamp.now()});
    }
    imageInput.value="";
    return;
  }

  if (!input.value.trim()) return;
  if (activeFriend==="General Chat") {
    await addDoc(generalCollection, {from:currentUser, message:input.value.trim(), timestamp:Timestamp.now()});
  } else {
    await addDoc(collection(db,"messages"), {chatId:activeChatId, from:currentUser, to:activeFriend, message:input.value.trim(), timestamp:Timestamp.now()});
  }
  input.value="";
}

window.selectFriend = selectFriend;
window.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("backBtn").addEventListener("click",()=>window.location.href="index.html");
  document.getElementById("sendBtn").addEventListener("click", sendMessage);
  document.getElementById("messageInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") sendMessage(); });
  document.getElementById("imageInput").addEventListener("change", sendMessage);
  loadUser();
});
</script>
</head>
<body>
  <div id="contentWrapper">
    <div id="pageTitle">Chat <span style="font-size:14px; font-weight:normal;">v4.0</span></div>
    <div id="topBar">
      <button id="backBtn">Back</button>
      <div id="usernameDisplay">Loading...</div>
    </div>

    <div id="chatContainer">
      <div id="friendsList"></div>
      <div id="chatArea">
        <div id="messages"></div>
        <div id="messageForm">
          <input type="text" id="messageInput" placeholder="Type a message..." />
          <input type="file" id="imageInput" accept="image/*" />
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
