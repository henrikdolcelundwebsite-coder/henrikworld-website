<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Chat - henrikworld.com</title>
<link rel="icon" href="favicon.png" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    height: 100vh;
    overflow: hidden;
    background: #f2f2f2;
  }

  /* Home button */
  .home-btn {
    position: fixed;
    top: 15px;
    left: 15px;
    background: #0077aa;
    color: white;
    padding: 8px 15px;
    border-radius: 25px;
    font-weight: bold;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 1001;
    transition: 0.2s;
  }
  .home-btn:hover { background: #005f88; }
  .home-btn i { font-size: 16px; }

  /* Username display */
  #usernameDisplay {
    position: fixed;
    top: 15px;
    right: 15px;
    font-weight: bold;
    background: #0077aa;
    color: white;
    padding: 8px 15px;
    border-radius: 25px;
    z-index: 1001;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* Sidebar */
  #friendsSidebar {
    width: 300px;
    background: #fff;
    border-right: 1px solid #ccc;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    padding-top: 60px;
    z-index: 1000;
  }
  .friend-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    gap: 12px;
  }
  .friend-item:hover { background: #f5f5f5; }
  .friend-item i {
    font-size: 36px;
    color: #555;
    width: 48px;
    height: 48px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .friend-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
  .friend-name { font-weight: bold; }
  .friend-last-msg { color: #888; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Chat area */
  #chatArea {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    min-height: 0;
    height: 100vh;
  }
  #chatHeader { background: #0077aa; color: white; padding: 15px; font-weight: bold; flex-shrink: 0; }
  #chatMessages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-height: 0;
  }
  .message {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 15px;
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: anywhere;
    white-space: pre-wrap;
    line-height: 1.4;
  }
  .message.sent { align-self: flex-end; background: #009955; color: white; }
  .message.received { align-self: flex-start; background: #e0e0e0; color: black; }

  /* Input area */
  #chatInputArea {
    display: flex;
    gap: 10px;
    padding: 10px 15px;
    border-top: 1px solid #ccc;
    background: #fff;
    align-items: flex-end;
    position: sticky;
    bottom: 0;
    z-index: 500;
  }
  #chatInput {
    flex: 1;
    padding: 10px 15px;
    border-radius: 25px;
    border: 1px solid #ccc;
    font-size: 16px;
    resize: none;
    min-height: 40px;
    max-height: 120px;
    overflow-y: auto;
    line-height: 1.4;
    -webkit-overflow-scrolling: touch;
    box-sizing: border-box;
    display: block;
  }
  #sendBtn {
    background: #0077aa;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 15px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    height: 42px;
  }
  #sendBtn:hover { background: #005f88; }

  .empty-state {
    text-align: center;
    margin-top: 50px;
    color: #888;
    font-size: 16px;
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    #friendsSidebar {
      position: absolute;
      left: -100%;
      top: 0;
      height: 100%;
      transition: left 0.3s;
      z-index: 1002;
    }
    #friendsSidebar.show { left: 0; }
    #chatArea { width: 100%; }
    #sidebarToggle { display: block; }
  }

  /* Sidebar toggle button */
  #sidebarToggle {
    display: none;
    position: fixed;
    top: 15px;
    left: 80px;
    z-index: 1003;
    font-size: 24px;
    cursor: pointer;
    color: #0077aa;
  }
</style>
</head>
<body>

<a href="index.html" class="home-btn"><i class="fas fa-home"></i> Home</a>
<i id="sidebarToggle" class="fas fa-bars"></i>

<div id="usernameDisplay"><i class="fas fa-user"></i> <span id="usernameText"></span></div>

<div id="friendsSidebar">
  <div id="friendsList"></div>
</div>

<div id="chatArea">
  <div id="chatHeader">Select a friend</div>
  <div id="chatMessages">
    <div class="empty-state">No chat selected.</div>
  </div>

  <div id="chatInputArea">
    <textarea id="chatInput" placeholder="Type a message..." rows="1"></textarea>
    <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, updateDoc, arrayUnion, onSnapshot, addDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA-Kcwv7BtU6cN41WbItJM1hInjy2Q83GI",
  authDomain: "henrikworld-818f9.firebaseapp.com",
  projectId: "henrikworld-818f9",
  storageBucket: "henrikworld-818f9.firebasestorage.app",
  messagingSenderId: "977398255809",
  appId: "1:977398255809:web:68febbb7f2cbc452064440",
  measurementId: "G-L2CKVDT4L3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const username = localStorage.getItem("username");
if (!username) window.location.href = "login.html";
document.getElementById("usernameText").textContent = username;

const friendsListEl = document.getElementById("friendsList");
const chatHeader = document.getElementById("chatHeader");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const sidebarToggle = document.getElementById("sidebarToggle");
const friendsSidebar = document.getElementById("friendsSidebar");

let selectedFriend = null;
let chatId = null;
let messagesUnsubscribe = null;

sidebarToggle.addEventListener("click", () => friendsSidebar.classList.toggle("show"));

// Auto-resize textarea
function resizeTextarea(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}
chatInput.addEventListener('input', () => resizeTextarea(chatInput));

// Scroll chat to bottom reliably
function scrollChatToBottom() {
  setTimeout(() => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }, 50);
}
chatInput.addEventListener("focus", scrollChatToBottom);

async function loadFriends() {
  const q = query(collection(db, "accounts"), where("username", "==", username));
  const snap = await getDocs(q);
  if (snap.empty) return;
  const userDoc = snap.docs[0];
  const friends = userDoc.data().friends || [];

  friendsListEl.innerHTML = "";
  if (!friends.length) {
    friendsListEl.innerHTML = `<div class="empty-state">You have no friends. Add some to start chatting!</div>`;
    return;
  }

  friends.forEach(f => {
    const item = document.createElement("div");
    item.className = "friend-item";
    const icon = document.createElement("i");
    icon.className = "fas fa-user";
    const info = document.createElement("div");
    info.className = "friend-info";
    const name = document.createElement("div");
    name.className = "friend-name";
    name.textContent = f.username;
    info.appendChild(name);
    const lastMsg = document.createElement("div");
    lastMsg.className = "friend-last-msg";
    lastMsg.textContent = "";
    info.appendChild(lastMsg);
    item.appendChild(icon);
    item.appendChild(info);
    item.addEventListener("click", () => selectFriend(f.username));
    friendsListEl.appendChild(item);

    const chatDocId = [username, f.username].sort().join("_");
    const chatRef = collection(db, "chats", chatDocId, "messages");
    onSnapshot(query(chatRef, orderBy("timestamp", "desc")), snap => {
      if (snap.empty) { lastMsg.textContent = ""; return; }
      const lastMessage = snap.docs[0].data();
      lastMsg.textContent = !lastMessage.readBy?.includes(username) ? "New message" : lastMessage.content;
    });
  });
}

async function selectFriend(friend) {
  selectedFriend = friend;
  chatHeader.textContent = `Chat with ${friend}`;
  chatId = [username, friend].sort().join("_");
  friendsSidebar.classList.remove("show");

  if (messagesUnsubscribe) messagesUnsubscribe();
  chatMessages.innerHTML = "";

  const chatRef = collection(db, "chats", chatId, "messages");
  messagesUnsubscribe = onSnapshot(query(chatRef, orderBy("timestamp")), snap => {
    chatMessages.innerHTML = "";
    if (snap.empty) {
      chatMessages.innerHTML = `<div class="empty-state">No messages yet. Say hello!</div>`;
      return;
    }

    snap.docs.forEach(docSnap => {
      const msg = docSnap.data();
      const div = document.createElement("div");
      div.className = "message " + (msg.sender === username ? "sent" : "received");
      div.textContent = msg.content;
      chatMessages.appendChild(div);

      if (!msg.readBy?.includes(username)) {
        updateDoc(docSnap.ref, { readBy: arrayUnion(username) });
      }
    });

    scrollChatToBottom();
  });
}

sendBtn.addEventListener("click", async () => {
  const text = chatInput.value.trim();
  if (!text || !selectedFriend) return;

  const chatDocRef = doc(db, "chats", chatId);
  const messagesRef = collection(chatDocRef, "messages");

  await updateDoc(chatDocRef, { participants: arrayUnion(username, selectedFriend) }).catch(async () => {
    await setDoc(chatDocRef, { participants: [username, selectedFriend] });
  });

  await addDoc(messagesRef, { sender: username, content: text, timestamp: new Date(), readBy: [username] });
  chatInput.value = "";
  resizeTextarea(chatInput);
  scrollChatToBottom();
});

chatInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }
});

loadFriends();
</script>
</body>
</html>
