<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Henrik AI</title>
<style>
  body { font-family: monospace; margin:0; padding:0; height:100vh; display:flex; flex-direction:column; background:white; color:black; }
  #topBar { display:flex; justify-content:space-between; padding:10px 15px; border-bottom:1px solid #ccc; background:white; }
  #backBtn { background:white; border:1px solid #ccc; border-radius:4px; padding:6px 12px; cursor:pointer; }
  #backBtn:hover { background:#f5f5f5; }
  #usernameDisplay { border:1px solid #ccc; border-radius:4px; padding:6px 12px; cursor:pointer; }

  #chatArea { flex:1; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; overflow:hidden; }
  #messages { flex:1; overflow-y:auto; margin-bottom:10px; }
  .message { margin-bottom:10px; }
  .message.user { text-align:right; }
  .message .meta { font-size:10px; color:#888; }
  #messageForm { display:flex; gap:5px; }
  #messageInput { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; }
  #sendBtn { padding:8px 12px; border:1px solid #ccc; border-radius:4px; background:white; cursor:pointer; }
  #sendBtn:hover { background:#f5f5f5; }
</style>
</head>
<body>

<div id="topBar">
  <button id="backBtn">Back</button>
  <div id="usernameDisplay">Loading...</div>
</div>

<div id="chatArea">
  <div id="messages"></div>
  <div id="messageForm">
    <input type="text" id="messageInput" placeholder="Ask Henrik AI..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
// UI elements
const usernameDisplay = document.getElementById("usernameDisplay");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const backBtn = document.getElementById("backBtn");

// Load the saved username
let savedUser = JSON.parse(localStorage.getItem("user"));
let currentUser = savedUser && savedUser.username ? savedUser.username : "Guest";
usernameDisplay.textContent = currentUser;

// Click username to log out
usernameDisplay.addEventListener("click", () => {
  localStorage.removeItem("user");
  window.location.href = "login.html";
});

// Back button
backBtn.addEventListener("click", () => {
  window.location.href = "index.html";
});

// Firebase Function API URL
const API_URL = "https://us-central1-henrikworldonline-a726f.cloudfunctions.net/henrikAI";

// Append message to chat window
function appendMessage(text, sender="ai") {
  const div = document.createElement("div");
  div.className = "message " + (sender === "user" ? "user" : "ai");
  const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  div.innerHTML = `<strong>${sender === "user" ? currentUser : "Henrik AI"}:</strong> ${text} <div class="meta">${time}</div>`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Send message to Firebase + OpenAI
async function sendMessage() {
  const prompt = messageInput.value.trim();
  if (!prompt) return;
  appendMessage(prompt, "user");
  messageInput.value = "";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });

    const data = await res.json();
    let reply = "No response";

    // Handle multiple possible formats
    if (data.output_text) reply = data.output_text;
    else if (data.output && Array.isArray(data.output)) {
      reply = data.output.map(o => o.content?.map(c => c.text).join(" ")).join(" ");
    } else if (data.choices && data.choices[0].message) {
      reply = data.choices[0].message.content;
    }

    appendMessage(reply, "ai");

  } catch (e) {
    console.error(e);
    appendMessage("Error connecting to Henrik AI.", "ai");
  }
}

// Send on button click or ENTER
sendBtn.addEventListener("click", sendMessage);
messageInput.addEventListener("keydown", e => {
  if (e.key === "Enter") sendMessage();
});
</script>

</body>
</html>
