<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HenrikAI - henrikworld.com</title>
<link rel="icon" type="image/png" href="favicon.png" />

<!-- Prism.js for code highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-python.min.js"></script>

<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: white; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
#topBar { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-bottom: 1px solid #ddd; background-color: white; }
#backBtn, #sendBtn, #usernameDisplay { border-radius: 12px; padding: 8px 16px; cursor: pointer; transition: all 0.2s ease; }
#backBtn, #sendBtn { border: 1px solid #ccc; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
#backBtn:hover, #sendBtn:hover, #usernameDisplay:hover { background-color: #f5f5f5; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.12); }
#usernameDisplay { font-weight: bold; font-size: 16px; border: 1px solid #ddd; padding: 8px 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
#chatContainer { flex: 1; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; }
#messages { flex: 1; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 12px; background-color: #fafafa; }
.msg { margin: 8px 0; line-height: 1.4; }
.username { font-weight: bold; color: #111; }
.ai-label { font-weight: bold; color: #0077cc; }
#inputBar { display: flex; gap: 10px; }
#userInput { flex: 1; padding: 12px 14px; border: 1px solid #ccc; border-radius: 12px; font-size: 14px; outline: none; transition: border 0.2s; }
#userInput:focus { border-color: #0077cc; }
pre { background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 12px; overflow-x: auto; position: relative; }
button.copy-btn { position: absolute; top: 8px; right: 8px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-radius: 6px; border: 1px solid #ccc; background: #fff; }
button.copy-btn:hover { background: #f5f5f5; }
@media (max-width: 500px) { #topBar { flex-direction: column; gap: 10px; } #backBtn, #sendBtn, #usernameDisplay { width: 100%; } }
</style>
</head>
<body>

<div id="topBar">
  <button id="backBtn">Back</button>
  <div id="usernameDisplay">Loading...</div>
</div>

<div id="chatContainer">
  <div id="messages"></div>
  <div id="inputBar">
    <input id="userInput" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAQnIe1Z-CMgyYOhKmfKVbLSall-R7frws",
  authDomain: "henrikworldonline-a726f.firebaseapp.com",
  databaseURL: "https://henrikworldonline-a726f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "henrikworldonline-a726f",
  storageBucket: "henrikworldonline-a726f.firebasestorage.app",
  messagingSenderId: "1060990020059",
  appId: "1:1060990020059:web:35e9816d249cd32d97dffe"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

const messagesDiv = document.getElementById("messages");
const input = document.getElementById("userInput");

let currentUser = "User";
const savedUser = JSON.parse(localStorage.getItem("user"));
if (savedUser?.username) currentUser = savedUser.username;
document.getElementById("usernameDisplay").textContent = currentUser;

document.getElementById("usernameDisplay").addEventListener("click", () => {
  localStorage.removeItem("user");
  window.location.href = "login.html";
});

let conversation = [{ role: "system", content: `
You are HenrikAI, a smart coding assistant.
- Always format code in triple backticks with language.
- Provide comments and explanations.
- Make code ready to copy and paste.
`}];

addMessage("HenrikAI", "Welcome to HenrikAI! Ask me anything.", true);

function addMessage(username, text, isAI=false, isCode=false) {
  const div = document.createElement("div");
  div.className = "msg";

  const label = document.createElement("span");
  label.className = isAI ? "ai-label" : "username";
  label.textContent = (isAI ? "HenrikAI" : username) + ": ";
  div.appendChild(label);

  if (isCode) {
    const pre = document.createElement("pre");
    const codeEl = document.createElement("code");
    codeEl.textContent = text;
    pre.appendChild(codeEl);

    const copyBtn = document.createElement("button");
    copyBtn.textContent = "Copy";
    copyBtn.className = "copy-btn";
    copyBtn.onclick = () => navigator.clipboard.writeText(text);
    pre.appendChild(copyBtn);

    div.appendChild(pre);
    messagesDiv.appendChild(div);
    Prism.highlightAll();
  } else {
    const span = document.createElement("span");
    span.textContent = text;
    div.appendChild(span);
    messagesDiv.appendChild(div);
  }

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function getOpenAIKey() {
  const dbRef = ref(database, "openai/apiKey");
  try {
    const snapshot = await get(dbRef);
    if (snapshot.exists()) return snapshot.val();
    await set(dbRef, "YOUR_API_KEY_HERE");
    console.warn("No API key found. Placeholder created in Firebase.");
    return null;
  } catch (err) {
    console.error("Firebase error:", err);
    return null;
  }
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  addMessage(currentUser, text);
  input.value = "";

  addMessage("HenrikAI", "Thinking...", true);
  const loadingEl = messagesDiv.lastChild;

  conversation.push({ role: "user", content: text });

  const OPENAI_API_KEY = await getOpenAIKey();
  if (!OPENAI_API_KEY || OPENAI_API_KEY === "YOUR_API_KEY_HERE") {
    loadingEl.remove();
    addMessage("HenrikAI", "API key not set. Please replace the placeholder in Firebase.", true);
    return;
  }

  try {
    const result = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${OPENAI_API_KEY}` },
      body: JSON.stringify({ model: "gpt-4o-mini", messages: conversation, temperature: 0.7, user: currentUser })
    });

    const data = await result.json();
    let reply = data.choices?.[0]?.message?.content || "(No response)";
    reply = reply.replace(/Chat ?GPT/gi, "HenrikAI");

    loadingEl.remove();

    // Split multiple code blocks if any
    const codeRegex = /```(\w+)?\n([\s\S]*?)```/g;
    let lastIndex = 0;
    let match;
    while ((match = codeRegex.exec(reply)) !== null) {
      const beforeText = reply.substring(lastIndex, match.index).trim();
      if (beforeText) addMessage("HenrikAI", beforeText, true);

      addMessage("HenrikAI", match[2], true, true);
      lastIndex = codeRegex.lastIndex;
    }

    const remainingText = reply.substring(lastIndex).trim();
    if (remainingText) addMessage("HenrikAI", remainingText, true);

    conversation.push({ role: "assistant", content: reply });
  } catch (err) {
    loadingEl.remove();
    addMessage("HenrikAI", "Error: Failed to fetch API.", true);
    console.error(err);
  }
}

document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("backBtn").addEventListener("click", () => window.location.href="index.html");
input.addEventListener("keydown", e => { if(e.key==="Enter") sendMessage(); });
</script>

</body>
</html>
