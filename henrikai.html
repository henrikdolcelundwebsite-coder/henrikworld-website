<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HenrikAI</title>
<style>
  body { font-family: monospace; background: white; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

  #topBar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid #ddd;
    background: white;
  }

  #backBtn {
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
  }
  #backBtn:hover { background: #f5f5f5; }

  #usernameDisplay {
    font-weight: bold;
  }

  #chatContainer { flex: 1; display: flex; flex-direction: column; padding: 10px; }
  #messages { flex: 1; overflow-y: auto; padding: 10px; }
  .msg { margin: 6px 0; }
  .username { font-weight: bold; }
  .ai-label { font-weight: bold; color: #444; }

  #inputBar { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #ddd; }
  #userInput { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
  #sendBtn { padding: 10px 15px; border: 1px solid #ccc; background: #fff; border-radius: 5px; cursor: pointer; }
  #sendBtn:hover { background: #f5f5f5; }
</style>
</head>
<body>

<div id="topBar">
  <button id="backBtn">Back</button>
  <div id="usernameDisplay">Loading...</div>
</div>

<div id="chatContainer">
  <div id="messages"></div>
  <div id="inputBar">
    <input id="userInput" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
const OPENAI_API_KEY = "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";
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("userInput");
let currentUser = "User";

// Load username from localStorage
const savedUser = JSON.parse(localStorage.getItem("user"));
if (savedUser?.username) currentUser = savedUser.username;
document.getElementById("usernameDisplay").textContent = currentUser;

// Conversation array to keep history
let conversation = [
  { role: "system", content: "You are HenrikAI, a helpful assistant." }
];

// Initial welcome message
addMessage("HenrikAI", "Welcome to HenrikAI! Ask me anything.", true);
conversation.push({ role: "assistant", content: "Welcome to HenrikAI! Ask me anything." });

function addMessage(username, text, isAI=false) {
  const div = document.createElement("div");
  div.className = "msg";
  const label = document.createElement("span");
  label.className = isAI ? "ai-label" : "username";
  label.textContent = (isAI ? "HenrikAI" : username) + ": ";
  div.appendChild(label);

  if (isAI) {
    const contentSpan = document.createElement("span");
    div.appendChild(contentSpan);
    typeWriter(text, contentSpan);
  } else {
    div.appendChild(document.createTextNode(text));
  }

  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function typeWriter(text, element) {
  let i = 0;
  const speed = 25;
  function type() {
    if (i < text.length) {
      element.textContent += text.charAt(i);
      i++;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      requestAnimationFrame(type);
    }
  }
  type();
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  addMessage(currentUser, text);
  input.value = "";

  addMessage("HenrikAI", "Thinking...", true);
  const loadingEl = messagesDiv.lastChild;

  // Add user message to conversation
  conversation.push({ role: "user", content: text });

  const result = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: conversation,
      temperature: 0.7,
      user: currentUser
    })
  });

  const data = await result.json();
  let reply = data.choices?.[0]?.message?.content || "(No response)";
  reply = reply.replace(/Chat ?GPT/gi, "HenrikAI");

  loadingEl.remove();
  addMessage("HenrikAI", reply, true);

  // Save AI's response to conversation
  conversation.push({ role: "assistant", content: reply });
}

document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("backBtn").addEventListener("click", () => window.location.href = "index.html");
input.addEventListener("keydown", e => { if(e.key === "Enter") sendMessage(); });
</script>
</body>
</html>