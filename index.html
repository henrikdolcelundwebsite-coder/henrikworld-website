<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€” Simple Line Editor</title>
  <style>
    body {
      margin: 0;
      background: white;
      color: black;
      font-family: monospace;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .editor {
      width: 80%;
      height: 70%;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      font-size: 16px;
      line-height: 1.5;
    }
    .line {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }
    .num {
      width: 40px;
      color: #888;
      text-align: right;
      padding-right: 10px;
    }
    .text {
      flex: 1;
      outline: none;
      white-space: pre;
    }
    button {
      background: #eee;
      border: 1px solid #ccc;
      padding: 8px 16px;
      cursor: pointer;
      font-family: monospace;
    }
    button:hover {
      background: #ddd;
    }
    .status { font-size: 13px; color: #444; }
  </style>
</head>
<body>
  <div class="editor" id="editor" aria-label="Admin command editor"></div>
  <button id="saveBtn">Save</button>
  <div class="status" id="status">Status: idle</div>

  <script type="module">
    // Firebase (modular) imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js';
    import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // <-- YOUR FIREBASE CONFIG (you provided this) -->
    const firebaseConfig = {
      apiKey: "AIzaSyA-Kcwv7BtU6cN41WbItJM1hInjy2Q83GI",
      authDomain: "henrikworld-818f9.firebaseapp.com",
      projectId: "henrikworld-818f9",
      storageBucket: "henrikworld-818f9.firebasestorage.app",
      messagingSenderId: "977398255809",
      appId: "1:977398255809:web:68febbb7f2cbc452064440",
      measurementId: "G-L2CKVDT4L3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) { /* analytics may fail in some environments */ }
    const db = getFirestore(app);

    const editor = document.getElementById('editor');
    const saveBtn = document.getElementById('saveBtn');
    const status = document.getElementById('status');

    let lineCount = 1;

    function createLine(num, content = '') {
      const line = document.createElement('div');
      line.className = 'line';

      const numDiv = document.createElement('div');
      numDiv.className = 'num';
      numDiv.textContent = num.toString().padStart(2, '0');

      const textDiv = document.createElement('div');
      textDiv.className = 'text';
      textDiv.contentEditable = true;
      textDiv.textContent = content;

      textDiv.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addNewLine();
        } else if (e.key === 'Backspace' && textDiv.textContent === '') {
          e.preventDefault();
          deleteLine(line);
        }
      });

      line.appendChild(numDiv);
      line.appendChild(textDiv);
      editor.appendChild(line);
      textDiv.focus();
    }

    function addNewLine() {
      lineCount++;
      createLine(lineCount);
      editor.scrollTop = editor.scrollHeight;
    }

    function deleteLine(line) {
      if (editor.children.length > 1) {
        line.remove();
        updateLineNumbers();
      }
    }

    function updateLineNumbers() {
      const lines = editor.querySelectorAll('.line');
      lineCount = lines.length;
      lines.forEach((line, index) => {
        line.querySelector('.num').textContent = (index + 1).toString().padStart(2, '0');
      });
    }

    // simple SHA-256 helper using Web Crypto
    async function sha256Hex(str) {
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function generateSalt(len = 16) {
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // parse lines for admin commands
    function parseCommands(lines) {
      // We'll look for sequences of lines that follow:
      // admin/account/create/username=...
      // admin/account/create/password=...
      // admin/account/create/finish
      const results = [];
      let current = null;

      for (const raw of lines) {
        const line = raw.trim();
        if (line.startsWith('admin/account/create/username=')) {
          if (!current) current = {};
          current.username = line.split('=')[1] || '';
        } else if (line.startsWith('admin/account/create/password=')) {
          if (!current) current = {};
          current.password = line.split('=')[1] || '';
        } else if (line === 'admin/account/create/finish') {
          if (current && current.username && current.password) {
            results.push({ username: current.username, password: current.password });
          }
          current = null;
        }
      }
      return results; // array of {username,password}
    }

    async function saveAccountsToFirestore(accounts) {
      // accounts: [{username,password}, ...]
      const saved = [];
      for (const acc of accounts) {
        try {
          const salt = generateSalt(12);
          const pwHash = await sha256Hex(salt + acc.password);
          const doc = { username: acc.username, passwordHash: pwHash, salt: salt, createdAt: serverTimestamp() };
          await addDoc(collection(db, 'accounts'), doc);
          saved.push(acc.username);
        } catch (err) {
          console.error('save failed', err);
          // if any write fails, we continue but report later
        }
      }
      return saved;
    }

    saveBtn.addEventListener('click', async () => {
      status.textContent = 'Status: parsing...';
      const lines = Array.from(editor.querySelectorAll('.text')).map(t => t.textContent || '');
      const accounts = parseCommands(lines);
      if (accounts.length === 0) {
        status.textContent = 'Status: no valid commands found (nothing will be saved)';
        return; // do nothing if invalid/incomplete
      }

      status.textContent = 'Status: saving...';
      const saved = await saveAccountsToFirestore(accounts);
      if (saved.length > 0) {
        status.textContent = `Status: saved ${saved.length} account(s): ${saved.join(', ')}`;
        alert('Saved accounts: ' + saved.join(', '));
      } else {
        status.textContent = 'Status: nothing saved (writes may have failed).';
      }
    });

    // initialize first line
    createLine(lineCount);
  </script>
</body>
</html>
